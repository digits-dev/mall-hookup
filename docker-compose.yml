version: "3.8"

services:
    app:
        image: mall-hookup/laravel-app:latest
        environment:
            APP_ENV: production
            APP_DEBUG: "false"
            APP_URL: http://localhost:8080
            DB_CONNECTION: mysql
            DB_HOST: db
            DB_PORT: 3306
            DB_DATABASE: mall_hookup
            DB_USERNAME: root
            DB_PASSWORD: ""
        depends_on: [db]
        networks: [laravel]
        restart: unless-stopped

    nginx:
        build:
            context: ./docker/nginx
            dockerfile: Dockerfile
        ports:
            - "8080:80"
        depends_on:
            - app
        networks:
            - laravel
        restart: unless-stopped

    db:
        image: mysql:8.0
        environment:
            MYSQL_ALLOW_EMPTY_PASSWORD: "yes"
            MYSQL_DATABASE: mall_hookup
        volumes:
            - dbdata:/var/lib/mysql
        networks: [laravel]
        restart: unless-stopped

    scheduler:
        image: mall-hookup/laravel-app:latest
        depends_on: [app]
        command: >
            sh -c 'while true; do php artisan schedule:run --no-interaction >> /var/www/storage/logs/scheduler.log 2>&1; sleep 60; done'
        networks: [laravel]
        restart: unless-stopped

volumes:
    dbdata:

networks:
    laravel:
        driver: bridge
